# Архитектура проекта FastP

Этот документ предназначен для разработчиков, желающих понять внутреннее устройство приложения FastP.

## Общий обзор
FastP использует архитектурный паттерн **MVVM (Model-View-ViewModel)**. Это стандарт де-факто для WPF приложений, позволяющий отделить логику приложения от пользовательского интерфейса.

### Основные слои
1. **Model (Сервисы)**: 
   - Отвечают за бизнес-логику (сортировка файлов, чтение конфигов).
   - Не знают о существовании интерфейса.
   - Находятся в папке `Services/`.

2. **ViewModel**: 
   - Связующее звено между UI и логикой.
   - Подготавливает данные для отображения (Binding).
   - Обрабатывает команды пользователя.
   - Находятся в папке `ViewModels/`.

3. **View (Представление)**: 
   - XAML файлы, описывающие внешний вид.
   - Содержат минимум кода (Code-behind).
   - Находятся в папке `Views/`.

---

## Детальное описание компонентов

### 1. Services (Бизнес-логика)

#### `FileSorterService.cs`
"Сердце" приложения. Отвечает за наблюдение за файловой системой и перемещение файлов.

- **FileSystemWatcher**: Используется системный класс для перехвата событий создания файлов (`Created`) и изменения (`Changed`).
- **Обработка блокировок**: Файлы (особенно большие) могут быть заняты браузером во время загрузки. Реализован механизм `IsFileLocked` и повторные попытки (`Task.Delay`) обработки.
- **События (Events)**:
  - `LogMessage`: Для отправки логов в UI.
  - `FilesProcessedChanged`: Уведомление об изменении счетчиков.
  - `FileMoved`: Уведомление об успешном перемещении (для Toast-уведомлений).

#### `ConfigManager.cs`
Управляет настройками приложения.

- **Хранение**: Использует JSON файлы (`rules.json` для правил, `settings.json` для настроек).
- **Структура**:
  - `Rules`: Словарь `Dictionary<string, string>` (Расширение -> Папка).
  - `AppSettings`: Класс с настройками (пути, флаги).

### 2. ViewModels

#### `MainViewModel.cs`
Управляет состоянием главного окна.

- Реализует `INotifyPropertyChanged` для обновления UI.
- Подписывается на события `FileSorterService` и обновляет свойства (`FilesProcessedToday`, `Logs`).
- **Важно**: События от сервиса приходят из фоновых потоков. Обновление коллекций UI (например, `ObservableCollection<string> Logs`) обязательно выполняется через `Dispatcher`.

### 3. Views

#### `MainWindow.xaml`
Главное окно. Использует DataBinding для отображения данных из ViewModel.
- Логика сворачивания в трей реализована в code-behind (`MainWindow.xaml.cs`), так как это специфика работы с окнами Windows.

#### `SettingsWindow.xaml`
Диалоговое окно настроек.
- Позволяет редактировать коллекцию правил.
- При сохранении обновляет `ConfigManager` и вызывает перезагрузку сервиса.

---

## Потоковая модель (Threading)

1. **UI Thread**: Основной поток приложения. Обрабатывает отрисовку и ввод пользователя.
2. **ThreadPool**: `FileSystemWatcher` вызывает события в фоновых потоках.
   - **Критично**: Нельзя менять UI элементы (текст, списки) напрямую из события `watcher_Created`. Нужно использовать `App.Current.Dispatcher.Invoke(...)`.

## Диаграмма потока данных

```
[Файловая система] -> (Событие Created) -> [FileSorterService]
                                                |
                                         (Проверка правил)
                                                |
                                         [Перемещение файла]
                                                |
                                         (Событие FileMoved)
                                                |
                                         [MainViewModel]
                                                |
                                     (Dispatcher.Invoke)
                                                |
                                           [View (UI)]
```

